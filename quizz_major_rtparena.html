<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Rei do Major na RTP Arena</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://embed.twitch.tv/embed/v1.js"></script>
    <style>
        :root {
            /* Cores Base */
            --cor-arena-azul: #0074FF;
            --cor-arena-azul-hover: #005fcc;
            --cor-sucesso: #28a745;
            --cor-perigo: #dc3545;
            --cor-aviso: #ffc107;
            --cor-fundo-cartao: #ffffff;
            --cor-texto-principal: #212529;
            --cor-texto-secundario: #525f6c;
            --cor-borda: #dee2e6;
            --cor-sombra: rgba(0, 0, 0, 0.07);

            --fonte-principal: 'Roboto', 'Segoe UI', Arial, sans-serif;
            --border-radius-padrao: 8px;
            --sombra-cartao: 0 4px 12px var(--cor-sombra);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --cor-fundo-cartao: #2c2f3b;
                --cor-texto-principal: #e4e6eb;
                --cor-texto-secundario: #b0b3b8;
                --cor-borda: #424651;
                --cor-sombra: rgba(0, 0, 0, 0.25);
            }
        }

        body {
            font-family: var(--fonte-principal);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: transparent;
            color: var(--cor-texto-principal);
            box-sizing: border-box;
        }

        .main-panel {
            margin: 0 auto 20px auto;
            text-align: center;
        }
        
        .screen, .section {
            background-color: var(--cor-fundo-cartao);
            padding: 25px 30px;
            border-radius: var(--border-radius-padrao);
            box-shadow: var(--sombra-cartao);
            border: 1px solid var(--cor-borda);
            animation: fadeIn 0.5s ease;
        }
        
        .section::before {
             content: attr(data-title);
             font-weight: 700;
             font-size: 1.2em;
             color: var(--cor-texto-principal);
             display: block;
             margin-bottom: 15px;
             padding-bottom: 5px;
             border-bottom: 2px solid var(--cor-arena-azul);
             text-align: left;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1, h2, h3 {
            color: var(--cor-texto-principal);
            margin-top: 0;
            text-align: center;
        }

        h1 {
           font-size: 2em;
           color: var(--cor-arena-azul);
           margin-bottom: 5px;
        }

        h2 {
            font-size: 1.4em;
            margin-bottom: 20px;
        }
        
        h3 {
            font-size: 1.2em;
            color: var(--cor-arena-azul);
            margin-top: 25px;
            margin-bottom: 10px;
            border-top: 1px solid var(--cor-borda);
            padding-top: 20px;
        }
        .leaderboard-container h3 {
             border-top: none;
             padding-top: 0;
             margin-top: 0;
        }

        p {
            margin-bottom: 20px;
            font-size: 1.1em;
            color: var(--cor-texto-secundario);
        }

        #startScreen h2, #usernameScreen h2 {
           margin-top: 10px;
           margin-bottom: 25px;
        }

        button {
            padding: 12px 25px;
            background-color: var(--cor-arena-azul);
            color: white;
            border: none;
            border-radius: var(--border-radius-padrao);
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
            width: 100%;
            margin-top: 10px;
        }
        
        button.secondary-action {
            background-color: var(--cor-aviso);
            color: var(--cor-texto-principal);
            margin-top: 8px;
        }

        button:hover:not(:disabled) {
            background-color: var(--cor-arena-azul-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        button.secondary-action:hover:not(:disabled) {
            background-color: color-mix(in srgb, var(--cor-aviso) 85%, black);
        }


        button:disabled {
            background-color: #cccccc;
            color: #666666;
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 1px solid var(--cor-borda);
            border-radius: var(--border-radius-padrao);
            box-sizing: border-box;
            margin-bottom: 15px;
        }
        
        .error-message {
            color: var(--cor-perigo);
            font-weight: 500;
            margin-top: -10px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        #quizScreen #questionIndicator {
            font-size: 0.9em;
            font-weight: 500;
            color: var(--cor-texto-secundario);
            margin-bottom: 10px;
        }
        
        #quizScreen #questionTimerDisplay {
             font-size: 1.3em;
             font-weight: 700;
             color: var(--cor-perigo);
             margin: 15px 0;
             height: 25px; 
        }

        #answerOptions {
            margin: 20px 0;
            display: grid;
            gap: 10px;
        }

        .option-btn {
            background-color: var(--cor-arena-azul);
            color: white;
            border: 1px solid var(--cor-arena-azul);
            text-align: left;
            padding: 15px;
            text-transform: none;
            font-size: 0.95em;
        }

        .option-btn:hover:not(:disabled) {
            background-color: var(--cor-arena-azul-hover);
        }

        .option-btn.correct {
            background-color: var(--cor-sucesso);
            color: white;
            border-color: var(--cor-sucesso);
            font-weight: 700;
        }
        
        .option-btn.incorrect {
            background-color: var(--cor-perigo);
            color: white;
            border-color: var(--cor-perigo);
            font-weight: 700;
        }

        .option-btn:disabled {
             opacity: 1;
        }
        .option-btn:not(.correct):not(.incorrect):disabled {
            opacity: 0.6;
            background-color: var(--cor-borda);
            color: var(--cor-texto-secundario);
            border-color: var(--cor-borda);
        }

        #nextQuestionButton {
            background-color: var(--cor-sucesso);
        }
        
        #resultsScreen #finalScore {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--cor-arena-azul);
            margin: 10px 0;
        }
        
        #resultsScreen #finalMessage {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--cor-arena-azul);
            margin: 15px 0 25px 0;
            min-height: 50px;
        }
        
        #socialShareMenu {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--cor-borda);
        }
        
        #socialShareMenu button {
           font-size: 0.8em;
           padding: 10px 15px;
           width: 80%;
           max-width: 250px;
           margin: 5px auto;
        }

        #shareOnXButton { background-color: #1DA1F2; }
        #shareOnWhatsAppButton { background-color: #25D366; }
        #closeShareMenuButton { background-color: var(--cor-texto-secundario); }

        #twitchPlayerSection .section-content-wrapper {
             width: 100%;
             aspect-ratio: 16 / 9;
             margin: 0 auto;
        }
        #twitch-embed {
             width: 100%;
             height: 100%;
        }

        #pageFooter {
             text-align: center;
             padding: 20px 10px;
             margin-top: 30px;
             border-top: 1px solid var(--cor-borda);
             font-size: 0.9em;
             color: var(--cor-texto-secundario);
        }

        .leaderboards-wrapper {
            display: flex;
            gap: 20px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--cor-borda);
        }

        .leaderboard-container {
            flex: 1;
            min-width: 0; /* Prevents flex items from overflowing */
        }
        
        @media (max-width: 768px) {
            .leaderboards-wrapper {
                flex-direction: column;
            }
        }


        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }
        .leaderboard-table th, .leaderboard-table td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--cor-borda);
            text-align: left;
        }
        .leaderboard-table th {
            font-weight: 700;
            color: var(--cor-texto-secundario);
        }
        .leaderboard-table .rank-col { width: 40px; text-align: center; }
        .leaderboard-table .score-col { width: 80px; text-align: right; }
        .leaderboard-table tr.user-highlight td {
            font-weight: 700;
            color: var(--cor-arena-azul);
        }

    </style>
</head>
<body>
    <!-- Ecr√£ de Loading -->
     <div id="loadingScreen" class="screen main-panel">
        <h2>A Carregar o Quiz...</h2>
        <p>Por favor, aguarde.</p>
    </div>

    <!-- Ecr√£ de Username -->
    <div id="usernameScreen" class="screen main-panel" style="display: none;">
        <h2>Bem-vindo ao Quiz do Major!</h2>
        <p>Introduz um nome de utilizador para poderes competir.</p>
        <input type="text" id="usernameInput" placeholder="O teu nome de jogador..." maxlength="20">
        <p id="usernameError" class="error-message" style="display: none;"></p>
        <button id="continueButton">Continuar</button>
        <button id="viewLeaderboardsFromUsernameButton" class="secondary-action">Ver Classifica√ß√µes</button>
    </div>

    <!-- Ecr√£ Inicial -->
    <div id="startScreen" class="screen main-panel" style="display: none;">
        <h2>Escolhe o dia do Quiz:</h2>
        <div id="day-selection">
            <button id="start-day-1" disabled title="Espera pelo dia do quiz">Dia 1 (Quinta-feira)</button>
            <button id="start-day-2" disabled title="Abre √†s 18h00 de Sexta-feira">Dia 2 (Sexta-feira)</button>
            <button id="start-day-3" disabled title="Abre √†s 18h00 de S√°bado">Dia 3 (S√°bado)</button>
            <button id="start-day-4" disabled title="Abre √†s 18h00 de Domingo">Dia 4 (Domingo)</button>
        </div>
        <button id="viewLeaderboardsButton" class="secondary-action">Ver Classifica√ß√µes</button>
    </div>

    <!-- Ecr√£ do Quiz -->
    <div id="quizScreen" class="screen main-panel" style="display: none;">
        <p id="questionIndicator">Pergunta 1/10</p>
        <div id="questionTimerDisplay">Tempo: 15s</div>
        <h2 id="questionText">Qual √© a pergunta?</h2>
        <div id="answerOptions"></div>
        <button id="nextQuestionButton" style="display: none;">Pr√≥xima Pergunta</button>
    </div>

    <!-- Ecr√£ de Resultados -->
    <div id="resultsScreen" class="screen main-panel" style="display: none;">
        <div id="personalResultsWrapper">
            <h1>Quiz Terminado!</h1>
            <p>A sua pontua√ß√£o final foi:</p>
            <p id="finalScore">0/10</p>
            <p id="finalMessage"></p>
            <button id="restartButton">Voltar ao Menu Principal</button>
            <button id="shareResultsButton">Partilhar Resultado</button>
            <div id="socialShareMenu" style="display: none;">
                <button id="shareOnXButton">Partilhar no X</button>
                <button id="shareOnWhatsAppButton">Partilhar no WhatsApp</button>
                <button id="closeShareMenuButton">Fechar</button>
            </div>
        </div>
        
        <div class="leaderboards-wrapper">
            <div class="leaderboard-container">
                <h3 id="leaderboardTitleDaily">Tabela Di√°ria</h3>
                <div style="overflow-x:auto;">
                    <table id="leaderboardTableDaily" class="leaderboard-table">
                        <thead>
                            <tr>
                                <th class="rank-col">#</th>
                                <th>Nome</th>
                                <th class="score-col">Pontos</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <p id="leaderboardLoadingDaily" style="display: none;">A carregar...</p>
            </div>
            <div class="leaderboard-container">
                <h3 id="leaderboardTitleGlobal">Tabela Geral</h3>
                <div style="overflow-x:auto;">
                    <table id="leaderboardTableGlobal" class="leaderboard-table">
                         <thead>
                            <tr>
                                <th class="rank-col">#</th>
                                <th>Nome</th>
                                <th class="score-col">Total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <p id="leaderboardLoadingGlobal" style="display: none;">A carregar...</p>
            </div>
        </div>
        <button id="backToStartButton" style="display: none;">Voltar ao Menu Principal</button>
    </div>

    <div id="twitchPlayerSection" class="section main-panel" data-title="Assiste em Direto!">
        <div class="section-content-wrapper">
             <div id="twitch-embed"></div>
        </div>
   </div>

    <footer id="pageFooter" class="main-panel">
        <p>Idealizado e produzido por: I√∫ri Martins</p>
        <p>&copy; <span id="currentYear"></span> Todos os direitos reservados.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let auth, db, currentUser;
        
        async function initFirebase() {
             const firebaseConfig = {
                apiKey: "AIzaSyClsfm7qk7zUp0O_n8nEFiYUyscE1vfbKs",
                authDomain: "quiz-rei-do-major.firebaseapp.com",
                projectId: "quiz-rei-do-major",
                storageBucket: "quiz-rei-do-major.appspot.com",
                messagingSenderId: "944435889357",
                appId: "1:944435889357:web:c5d43b47c6b3daf29d9584"
             };

            if (!firebaseConfig.apiKey) {
                console.warn("Configura√ß√£o do Firebase n√£o preenchida. As funcionalidades de leaderboard estar√£o desativadas.");
                return false;
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                return new Promise((resolve) => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUser = user;
                             console.log("Utilizador autenticado:", currentUser.uid);
                            resolve(true);
                        } else {
                           try {
                                const userCredential = await signInAnonymously(auth);
                                currentUser = userCredential.user;
                                console.log("Novo utilizador an√≥nimo autenticado:", currentUser.uid);
                                resolve(true);
                           } catch (error) {
                                console.error("Falha na autentica√ß√£o an√≥nima:", error);
                                resolve(false);
                           }
                        }
                    });
                });
            } catch (error) {
                console.error("Erro ao inicializar o Firebase:", error);
                return false;
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            
            // DOM Elements
            const loadingScreen = document.getElementById('loadingScreen');
            const usernameScreen = document.getElementById('usernameScreen');
            const startScreen = document.getElementById('startScreen');
            const quizScreen = document.getElementById('quizScreen');
            const resultsScreen = document.getElementById('resultsScreen');
            
            const usernameInput = document.getElementById('usernameInput');
            const usernameError = document.getElementById('usernameError');
            const continueButton = document.getElementById('continueButton');

            const startDay1Button = document.getElementById('start-day-1');
            const startDay2Button = document.getElementById('start-day-2');
            const startDay3Button = document.getElementById('start-day-3');
            const startDay4Button = document.getElementById('start-day-4');
            
            const questionIndicator = document.getElementById('questionIndicator');
            const questionText = document.getElementById('questionText');
            const answerOptions = document.getElementById('answerOptions');
            const nextQuestionButton = document.getElementById('nextQuestionButton');
            const questionTimerDisplay = document.getElementById('questionTimerDisplay');
            
            const personalResultsWrapper = document.getElementById('personalResultsWrapper');
            const finalScore = document.getElementById('finalScore');
            const finalMessage = document.getElementById('finalMessage');
            const restartButton = document.getElementById('restartButton');
            const backToStartButton = document.getElementById('backToStartButton');

            const shareResultsButton = document.getElementById('shareResultsButton');
            const socialShareMenu = document.getElementById('socialShareMenu');
            const shareOnXButton = document.getElementById('shareOnXButton');
            const shareOnWhatsAppButton = document.getElementById('shareOnWhatsAppButton');
            const closeShareMenuButton = document.getElementById('closeShareMenuButton');
            
            const viewLeaderboardsButton = document.getElementById('viewLeaderboardsButton');
            const viewLeaderboardsFromUsernameButton = document.getElementById('viewLeaderboardsFromUsernameButton');

            const leaderboardTitleDaily = document.getElementById('leaderboardTitleDaily');
            const leaderboardTableDailyBody = document.querySelector('#leaderboardTableDaily tbody');
            const leaderboardLoadingDaily = document.getElementById('leaderboardLoadingDaily');
            
            const leaderboardTableGlobalBody = document.querySelector('#leaderboardTableGlobal tbody');
            const leaderboardLoadingGlobal = document.getElementById('leaderboardLoadingGlobal');
            
            const quizData = {
                quinta: [
                    { pergunta: "Quem venceu o √∫ltimo Major de CS2?", opcoes: ["FaZe", "Spirit", "Vitality", "MOUZ"], respostaCorreta: "Spirit" },
                    { pergunta: "Quais foram as equipas que ficaram 3-0 no Stage 1 do Major de Austin?", opcoes: ["Legacy e HEROIC", "B8 e HEROIC", "BetBoom e OG", "Nemiga e HEROIC"], respostaCorreta: "B8 e HEROIC" },
                    { pergunta: "Contra quem foi o melhor mapa de s1mple no Major?", opcoes: ["HEROIC", "Legacy", "The MongolZ", "MIBR"], respostaCorreta: "HEROIC" },
                    { pergunta: "Quantas vit√≥rias consecutivas a Vitality conseguiu?", opcoes: ["33", "30", "28", "25"], respostaCorreta: "30" },
                    { pergunta: "Qual a equipa com mais finais de Major disputadas?", opcoes: ["Astralis", "NIP", "fnatic", "NAVI"], respostaCorreta: "NAVI" },
                    { pergunta: "Quem foi o melhor AWPer do Stage 3 do Major de Austin?", opcoes: ["s1mple", "molodoy", "sh1ro", "ultimate"], respostaCorreta: "s1mple" },
                    { pergunta: "Qual o pr√©mio para o vencedor do Major?", opcoes: ["350,000$", "600,000$", "450,000$", "500,000$"], respostaCorreta: "500,000$" },
                    { pergunta: "Quantos torneios Major foram jogados nos Estados Unidos?", opcoes: ["2", "3", "5", "4"], respostaCorreta: "4" },
                    { pergunta: "Qual a equipa com mais rondas ganhas no Stage 3 do Major de Austin?", opcoes: ["paiN", "MOUZ", "G2", "MongolZ"], respostaCorreta: "MOUZ" },
                    { pergunta: "Qual o Major com maior prize pool de sempre?", opcoes: ["PGL Major Estocolmo 2021", "BLAST.tv Paris Major 2023", "FACEIT Major 2018", "ELEAGUE Major 2017"], respostaCorreta: "PGL Major Estocolmo 2021" }
                ],
                sexta: [
                    { pergunta: "Qual o mapa mais jogado do Major at√© agora?", opcoes: ["Inferno", "Nuke", "Dust2", "Mirage"], respostaCorreta: "Dust2" },
                    { pergunta: "Qual a equipa com a maior percentagem de rondas ganhas a T no Stage 3?", opcoes: ["Vitality", "paiN", "FaZe", "NAVI"], respostaCorreta: "FaZe" },
                    { pergunta: "Quantos Majors venceu FalleN?", opcoes: ["1", "3", "0", "2"], respostaCorreta: "2" },
                    { pergunta: "Qual o IGL com o melhor rating do Stage 3", opcoes: ["FalleN", "bLitz", "lux", "apEX"], respostaCorreta: "bLitz" },
                    { pergunta: "Quem √© o jogador mais velho nos playoffs do Major?", opcoes: ["FalleN", "karrigan", "chopper", "rain"], respostaCorreta: "karrigan" },
                    { pergunta: "Qual o Major com maior pico de audi√™ncia?", opcoes: ["BLAST.tv Paris Major", "IEM Rio Major", "PGL Estocolmo Major", "BLAST.tv Austin Major"], respostaCorreta: "PGL Estocolmo Major" },
                    { pergunta: "Qual a equipa com a maior percentagem de rondas ganhas a CT no Stage 3?", opcoes: ["Legacy", "Vitality", "Spirit", "FURIA"], respostaCorreta: "FURIA" },
                    { pergunta: "Qual foi a primeira equipa a vencer o Major sem perder mapas?", opcoes: ["NIP", "NAVI", "Spirit", "Virtus.pro"], respostaCorreta: "NAVI" },
                    { pergunta: "Qual o mapa mais CT Sided do Major at√© agora?", opcoes: ["Inferno", "Anubis", "Train", "Nuke"], respostaCorreta: "Nuke" },
                    { pergunta: "Qual o jogador com mais assists no Major?", opcoes: ["Brollan", "biguzera", "xertioN", "HeavyGod"], respostaCorreta: "xertioN" }
                ],
                sabado: [],
                domingo: []
            };

            // Game State
            let currentQuiz = [];
            let currentDayKey = '';
            let currentUsername = '';
            let currentQuestionIndex = 0;
            let score = 0;
            let questionTimer;
            let nextQuestionTimer;

            // Functions
            function renderTwitchPlayer(){
                const currentYearSpan = document.getElementById('currentYear');
                if(currentYearSpan) currentYearSpan.textContent = new Date().getFullYear();
                new Twitch.Embed("twitch-embed", { width: "100%", height: "100%", channel: "rtparenacs", layout: "video", autoplay: false, parent: ["arena.rtp.pt", "www.arena.rtp.pt", "iurifgm96.github.io", "localhost", "cdpn.io"] });
            }
            
            function updateDayButtonsState() {
                const today = new Date();
                const quizDates = {
                    sexta: new Date('2025-06-20T18:00:00'),
                    sabado: new Date('2025-06-21T18:00:00'),
                    domingo: new Date('2025-06-22T18:00:00')
                };

                // Desbloqueia Dia 1 permanentemente
                if (quizData.quinta.length > 0) { 
                    startDay1Button.disabled = false; 
                    startDay1Button.title = 'Jogar o quiz de Quinta-feira';
                }

                if (today >= quizDates.sexta && quizData.sexta.length > 0) { startDay2Button.disabled = false; startDay2Button.title = 'Jogar o quiz de Sexta-feira'; }
                if (today >= quizDates.sabado && quizData.sabado.length > 0) { startDay3Button.disabled = false; startDay3Button.title = 'Jogar o quiz de S√°bado'; }
                if (today >= quizDates.domingo && quizData.domingo.length > 0) { startDay4Button.disabled = false; startDay4Button.title = 'Jogar o quiz de Domingo'; }
            }

            function startQuiz(dayKey) {
                currentDayKey = dayKey;
                currentQuiz = quizData[dayKey];
                
                const savedProgress = JSON.parse(localStorage.getItem('quizProgress'));
                if(savedProgress && savedProgress.day === dayKey) {
                    currentQuestionIndex = savedProgress.index;
                    score = savedProgress.score;
                } else {
                    currentQuestionIndex = 0;
                    score = 0;
                }
                
                startScreen.style.display = 'none';
                resultsScreen.style.display = 'none';
                quizScreen.style.display = 'block';
                
                showQuestion();
            }

            function showQuestion() {
                clearTimers();
                nextQuestionButton.style.display = 'none';
                answerOptions.innerHTML = '';

                const question = currentQuiz[currentQuestionIndex];
                questionIndicator.textContent = `Pergunta ${currentQuestionIndex + 1}/${currentQuiz.length}`;
                questionText.textContent = question.pergunta;

                question.opcoes.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.classList.add('option-btn');
                    button.onclick = () => selectAnswer(button, option);
                    answerOptions.appendChild(button);
                });

                startQuestionTimer(15);
            }

            function selectAnswer(selectedButton, selectedOption) {
                clearTimers(); 
                const question = currentQuiz[currentQuestionIndex];
                const isCorrect = selectedOption === question.respostaCorreta;

                if (isCorrect) {
                    score++;
                    selectedButton.classList.add('correct');
                } else {
                    selectedButton.classList.add('incorrect');
                    Array.from(answerOptions.children).forEach(btn => {
                        if (btn.textContent === question.respostaCorreta) {
                            btn.classList.add('correct');
                        }
                    });
                }

                Array.from(answerOptions.children).forEach(btn => btn.disabled = true);
                nextQuestionButton.style.display = 'block';
                startNextQuestionAdvanceTimer(5);
            }

            function handleTimeUp() {
                clearTimers();
                questionTimerDisplay.textContent = "Tempo Esgotado!";
                
                Array.from(answerOptions.children).forEach(btn => {
                    btn.disabled = true;
                    if (btn.textContent === currentQuiz[currentQuestionIndex].respostaCorreta) {
                        btn.classList.add('correct');
                    }
                });
                nextQuestionButton.style.display = 'block';
                startNextQuestionAdvanceTimer(5);
            }
            
            function startQuestionTimer(seconds) {
                let timeLeft = seconds;
                questionTimerDisplay.textContent = `Tempo: ${timeLeft}s`;
                questionTimer = setInterval(() => {
                    timeLeft--;
                    questionTimerDisplay.textContent = `Tempo: ${timeLeft}s`;
                    if (timeLeft < 0) { handleTimeUp(); }
                }, 1000);
            }
            
            function startNextQuestionAdvanceTimer(seconds) {
                let timeLeft = seconds;
                nextQuestionButton.textContent = `Pr√≥xima Pergunta (${timeLeft})`;
                nextQuestionTimer = setInterval(() => {
                    timeLeft--;
                    nextQuestionButton.textContent = `Pr√≥xima Pergunta (${timeLeft})`;
                    if (timeLeft < 0) { showNextQuestion(); }
                }, 1000);
            }

            function showNextQuestion() {
                clearTimers();
                currentQuestionIndex++;
                
                if (currentQuestionIndex < currentQuiz.length) {
                    localStorage.setItem('quizProgress', JSON.stringify({ day: currentDayKey, index: currentQuestionIndex, score: score }));
                    showQuestion();
                } else {
                    localStorage.removeItem('quizProgress');
                    showResults();
                }
            }

            async function showResults() {
                quizScreen.style.display = 'none';
                resultsScreen.style.display = 'block';
                personalResultsWrapper.style.display = 'block';
                backToStartButton.style.display = 'none';
                
                finalScore.textContent = `${score}/${currentQuiz.length}`;

                let message = "";
                const percentage = score / currentQuiz.length;
                if (percentage === 1) { message = "üëë Incr√≠vel! Coroado Rei (ou Rainha) do Major! √âs uma verdadeira lenda!"; } 
                else if (percentage >= 0.8) { message = "üî• Excelente pontua√ß√£o! Est√°s quase no topo."; } 
                else if (percentage >= 0.5) { message = "üëç Nada mau! Mostraste que percebes do assunto."; } 
                else if (percentage > 0) { message = "ü§î Ainda h√° margem para melhorar, mas foi um bom come√ßo!"; } 
                else { message = "üòÇ Para a pr√≥xima corre melhor! O importante √© participar."; }
                finalMessage.textContent = message;
                
                await saveScoreToFirestore();
                await refreshLeaderboards(currentDayKey, currentUser?.uid);
            }

            async function saveScoreToFirestore() {
                if (!db || !currentUser) return;
                
                try {
                    const scoresCollection = collection(db, 'quiz_scores');
                    const q = query(scoresCollection, where("userId", "==", currentUser.uid), where("day", "==", currentDayKey));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        await addDoc(scoresCollection, {
                            day: currentDayKey,
                            username: currentUsername,
                            score: score,
                            totalQuestions: currentQuiz.length,
                            timestamp: serverTimestamp(),
                            userId: currentUser.uid
                        });
                        console.log("Primeiro resultado do dia guardado com sucesso.");
                    } else {
                        console.log("Utilizador j√° tem um resultado para este dia. N√£o ser√° guardado novamente.");
                    }
                } catch (error) {
                    console.error("Erro ao guardar o resultado no Firestore:", error);
                }
            }
            
            async function refreshLeaderboards(dayKey, currentUid) {
                if (!db) {
                    leaderboardLoadingDaily.textContent = "Tabela indispon√≠vel.";
                    leaderboardLoadingGlobal.textContent = "Tabela indispon√≠vel.";
                    return;
                }

                leaderboardLoadingDaily.style.display = 'block';
                leaderboardLoadingGlobal.style.display = 'block';
                
                try {
                    const scoresCollection = collection(db, 'quiz_scores');
                    const querySnapshot = await getDocs(scoresCollection);
                    
                    let allScores = [];
                    querySnapshot.forEach((doc) => allScores.push(doc.data()));

                    // Process Daily Leaderboard
                    const dailyScores = allScores.filter(s => s.day === dayKey);
                    dailyScores.sort((a, b) => b.score - a.score || (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                    const topDailyScores = dailyScores.slice(0, 10);
                    const dayTitles = { quinta: "Dia 1", sexta: "Dia 2", sabado: "Dia 3", domingo: "Dia 4" };
                    leaderboardTitleDaily.textContent = `Tabela - ${dayTitles[dayKey] || ''}`;
                    populateLeaderboard(leaderboardTableDailyBody, topDailyScores, false, currentUid);

                    // Process Global Leaderboard
                    const userDailyBest = new Map();
                    allScores.forEach(s => {
                        const dayUserKey = `${s.userId}-${s.day}`;
                        if (!userDailyBest.has(dayUserKey) || s.score > userDailyBest.get(dayUserKey).score) {
                            userDailyBest.set(dayUserKey, s);
                        }
                    });

                    const userTotalScores = new Map();
                    userDailyBest.forEach(s => {
                        if (userTotalScores.has(s.userId)) {
                            userTotalScores.get(s.userId).totalScore += s.score;
                        } else {
                            userTotalScores.set(s.userId, { userId: s.userId, username: s.username, totalScore: s.score });
                        }
                    });

                    const aggregatedScores = Array.from(userTotalScores.values());
                    aggregatedScores.sort((a, b) => b.totalScore - a.totalScore);
                    const topGlobalScores = aggregatedScores.slice(0, 10);
                    populateLeaderboard(leaderboardTableGlobalBody, topGlobalScores, true, currentUid);

                } catch (error) {
                    console.error("Erro ao carregar tabelas de classifica√ß√£o:", error);
                    leaderboardTableDailyBody.innerHTML = `<tr><td colspan="3">N√£o foi poss√≠vel carregar a tabela.</td></tr>`;
                    leaderboardTableGlobalBody.innerHTML = `<tr><td colspan="3">N√£o foi poss√≠vel carregar a tabela.</td></tr>`;
                } finally {
                    leaderboardLoadingDaily.style.display = 'none';
                    leaderboardLoadingGlobal.style.display = 'none';
                }
            }
            
            function populateLeaderboard(tableBody, scores, isGlobal, currentUid) {
                tableBody.innerHTML = '';
                scores.forEach((entry, index) => {
                    const row = tableBody.insertRow();
                    const isCurrentUser = entry.userId === currentUid;
                    
                    if(isCurrentUser) {
                       row.classList.add('user-highlight');
                    }
                    
                    const scoreText = isGlobal ? entry.totalScore : `${entry.score}/${entry.totalQuestions || 10}`;
                    const usernameText = isCurrentUser ? `${entry.username} (Tu)` : entry.username;
                    
                    row.innerHTML = `
                        <td class="rank-col">${index + 1}</td>
                        <td>${usernameText}</td>
                        <td class="score-col">${scoreText}</td>
                    `;
                });

                if (scores.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="3">Ainda n√£o h√° resultados.</td></tr>`;
                }
            }
            
            function buildShareMessage(userScore, totalQuestions) {
                const linkDoArtigo = "https://arena.rtp.pt/ao-minuto/quiz-major/"; 
                let messageIntro = "";
                const percentage = userScore / totalQuestions;

                if (percentage === 1) { messageIntro = `Acertei ${userScore}/${totalQuestions} e sou o Rei do Major! üëë Achas que consegues fazer melhor?`; } 
                else if (percentage >= 0.8) { messageIntro = `Fiz ${userScore}/${totalQuestions} no quiz do Major! üî• Quase perfeito!`; } 
                else if (percentage >= 0.5) { messageIntro = `Fiz ${userScore}/${totalQuestions} no quiz da #MAJORnaRTP. üëç Um resultado s√≥lido! E tu, quantos pontos fazes?`; }
                else { messageIntro = `Fiz ${userScore}/${totalQuestions} no quiz da #MAJORnaRTP. üòÇ Preciso de ver mais a transmiss√£o para aprender! Tenta a tua sorte!`; }

                const fullText = `${messageIntro} Testa os teus conhecimentos e participa na transmiss√£o #MAJORnaRTP`;
                return { textForX: fullText, textForWhatsApp: `${fullText} ${linkDoArtigo}`, urlForX: linkDoArtigo };
            }

            function clearTimers() {
                clearInterval(questionTimer);
                clearInterval(nextQuestionTimer);
            }
            
            function handleUsername() {
                const savedUsername = localStorage.getItem('quizUsername');
                if (savedUsername) {
                    currentUsername = savedUsername;
                    usernameScreen.style.display = 'none';
                    startScreen.style.display = 'block';
                } else {
                    usernameScreen.style.display = 'block';
                    startScreen.style.display = 'none';
                }
            }
            
            async function showLeaderboardsOnly() {
                startScreen.style.display = 'none';
                usernameScreen.style.display = 'none';
                resultsScreen.style.display = 'block';
                personalResultsWrapper.style.display = 'none';
                backToStartButton.style.display = 'block';

                const latestDay = !startDay4Button.disabled ? 'domingo' : !startDay3Button.disabled ? 'sabado' : !startDay2Button.disabled ? 'sexta' : 'quinta';
                
                await refreshLeaderboards(latestDay, currentUser?.uid);
            }

            // EVENT LISTENERS
            continueButton.onclick = async () => {
                const username = usernameInput.value.trim();
                usernameError.style.display = 'none';

                if (!username) {
                    usernameError.textContent = "Por favor, introduz um nome de utilizador.";
                    usernameError.style.display = 'block';
                    return;
                }

                if (!db) {
                    console.warn("Firestore n√£o dispon√≠vel. A avan√ßar sem verificar nome de utilizador.");
                    currentUsername = username;
                    localStorage.setItem('quizUsername', username);
                    usernameScreen.style.display = 'none';
                    startScreen.style.display = 'block';
                    return;
                }

                continueButton.disabled = true;
                continueButton.textContent = "A VERIFICAR...";

                try {
                    const scoresCollection = collection(db, 'quiz_scores');
                    const q = query(scoresCollection, where("username", "==", username));
                    
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        usernameError.textContent = "Esse nome de utilizador j√° existe. Por favor, escolhe outro.";
                        usernameError.style.display = 'block';
                    } else {
                        currentUsername = username;
                        localStorage.setItem('quizUsername', username);
                        usernameScreen.style.display = 'none';
                        startScreen.style.display = 'block';
                    }
                } catch (error) {
                    console.error("Erro ao verificar nome de utilizador:", error);
                    usernameError.textContent = "Ocorreu um erro ao verificar o nome. Tenta novamente.";
                    usernameError.style.display = 'block';
                } finally {
                    continueButton.disabled = false;
                    continueButton.textContent = "Continuar";
                }
            };
            
            startDay1Button.onclick = () => startQuiz('quinta');
            startDay2Button.onclick = () => startQuiz('sexta');
            startDay3Button.onclick = () => startQuiz('sabado');
            startDay4Button.onclick = () => startQuiz('domingo');
            nextQuestionButton.onclick = showNextQuestion;
            
            const backToStart = () => {
                localStorage.removeItem('quizProgress');
                socialShareMenu.style.display = 'none';
                resultsScreen.style.display = 'none';
                quizScreen.style.display = 'none';
                handleUsername(); // Volta para o ecr√£ certo (username ou start)
            };

            restartButton.onclick = backToStart;
            backToStartButton.onclick = backToStart;
            
            viewLeaderboardsButton.onclick = showLeaderboardsOnly;
            viewLeaderboardsFromUsernameButton.onclick = showLeaderboardsOnly;

            shareResultsButton.onclick = () => { socialShareMenu.style.display = socialShareMenu.style.display === 'none' ? 'block' : 'none'; };
            closeShareMenuButton.onclick = () => { socialShareMenu.style.display = 'none'; };

            shareOnXButton.onclick = () => {
                const shareData = buildShareMessage(score, currentQuiz.length);
                const xUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareData.textForX)}&url=${encodeURIComponent(shareData.urlForX)}`;
                window.open(xUrl, '_blank');
            };

            shareOnWhatsAppButton.onclick = () => {
                const shareData = buildShareMessage(score, currentQuiz.length);
                const whatsAppUrl = `https://wa.me/?text=${encodeURIComponent(shareData.textForWhatsApp)}`;
                window.open(whatsAppUrl, '_blank');
            };

            // INICIALIZA√á√ÉO
            const firebaseReady = await initFirebase();
            loadingScreen.style.display = 'none';
            renderTwitchPlayer();
            updateDayButtonsState();
            
            if (firebaseReady) {
                const savedState = JSON.parse(localStorage.getItem('quizProgress'));
                if (savedState) {
                    // Se houver um quiz em progresso, continua-o
                    startQuiz(savedState.day);
                } else {
                    handleUsername();
                }
            } else {
                // Se o firebase falhar, esconde a parte do nome de utilizador e vai direto para o quiz.
                usernameScreen.style.display = 'none';
                startScreen.style.display = 'block';
                viewLeaderboardsButton.style.display = 'none'; 
            }
            
            // Hide screens not in use initially
            if (!localStorage.getItem('quizProgress')) {
                 quizScreen.style.display = 'none';
                 resultsScreen.style.display = 'none';
            }
        });
    </script>
</body>
</html>
