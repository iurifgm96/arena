<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa Interativo - SAW Torneios</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.polyline.snakeanim@1.0.0/leaflet.polyline.snakeanim.min.js"></script>
  <style>
    #map { height: 100vh; width: 100%; }
    .legend {
      background: white;
      padding: 8px;
      line-height: 1.3em;
      font-size: 11px;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      max-width: 200px;
    }
    .circle-icon {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle;
    }
    .label-tooltip {
      background: white;
      color: black;
      padding: 2px 4px;
      font-weight: bold;
      border: 1px solid gray;
      border-radius: 4px;
      font-size: 11px;
    }
  </style>
</head>
<body>
<div id="map"></div>
<script>
const map = L.map('map').setView([41.1496, -8.6109], 3);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '© OpenStreetMap'
}).addTo(map);

const cityCoords = {
  porto: [41.1496, -8.6109],
  krakow: [50.0647, 19.9450],
  madrid: [40.4168, -3.7038],
  bucharest: [44.4268, 26.1025],
  cluj: [46.7694, 23.5899],
  frankfurt: [50.1109, 8.6821],
  stockholm: [59.3293, 18.0686],
  dubai: [25.276987, 55.296249],
  melbourne: [-37.8136, 144.9631],
  beijing: [39.9042, 116.4074],
  ulaanbaatar: [47.8864, 106.9057]
};

const tournaments = [
  { name: "IEM Katowice 2025", location: "krakow", prize: "$2,500", color: "red", position: "21st-24th" },
  { name: "PGL Cluj-Napoca 2025", location: "cluj", prize: "$62,500", color: "blue", position: "5th-8th" },
  { name: "ESL Pro League Season 21", location: "stockholm", prize: "$10,500", color: "green", position: "12th-14th" },
  { name: "MRQ (BLAST)", location: "frankfurt", prize: null, color: "purple", position: "N/A" },
  { name: "IEM Melbourne 2025", location: "melbourne", prize: "$4,000", color: "orange", position: "13th-16th" },
  { name: "MESA Nomadic Masters Spring 2025", location: "ulaanbaatar", prize: null, color: "brown", position: "N/A" }
];

const bounds = [];
tournaments.forEach(t => {
  const coord = cityCoords[t.location];
  if (!coord) return;
  bounds.push(coord);

  const prizeValue = t.prize ? parseInt(t.prize.replace(/\D/g, '')) : 0;
  const radius = t.prize ? 6 + prizeValue / 20000 : 6;

  const marker = L.circleMarker(coord, {
    radius: radius,
    color: t.color,
    fillColor: t.color,
    fillOpacity: t.prize ? 0.8 : 0,
    weight: 2
  }).addTo(map);

  marker.bindPopup(`<b>${t.name}</b><br>Localização: ${capitalize(t.location)}<br>Prémio: ${t.prize || "Sem prémio"}<br>Posição: ${t.position}`);
  marker.bindTooltip(t.name, { permanent: true, direction: 'top', className: 'label-tooltip' });
});

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

const routes = {
  katowice: [
    { from: 'porto', to: 'krakow' },
    { from: 'krakow', to: 'porto', return: true }
  ],
  cluj: [
    { from: 'porto', to: 'madrid' },
    { from: 'madrid', to: 'bucharest' },
    { from: 'bucharest', to: 'cluj' },
    { from: 'cluj', to: 'bucharest', return: true },
    { from: 'bucharest', to: 'madrid', return: true },
    { from: 'madrid', to: 'porto', return: true }
  ],
  esl: [
    { from: 'porto', to: 'frankfurt' },
    { from: 'frankfurt', to: 'stockholm' },
    { from: 'stockholm', to: 'porto', return: true }
  ],
  combined: [
    { from: 'porto', to: 'frankfurt' },
    { from: 'frankfurt', to: 'dubai' },
    { from: 'dubai', to: 'melbourne' },
    { from: 'melbourne', to: 'beijing' },
    { from: 'beijing', to: 'ulaanbaatar' },
    { from: 'ulaanbaatar', to: 'frankfurt', return: true },
    { from: 'frankfurt', to: 'porto', return: true }
  ]
};

const colors = {
  katowice: 'red',
  cluj: 'blue',
  esl: 'green',
  combined: 'purple'
};

const routeLayers = {};
function calculateDistance(coord1, coord2) {
  const R = 6371;
  const dLat = (coord2[0]-coord1[0]) * Math.PI/180;
  const dLon = (coord2[1]-coord1[1]) * Math.PI/180;
  const lat1 = coord1[0] * Math.PI/180;
  const lat2 = coord2[0] * Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

for (const key in routes) {
  const group = L.layerGroup();
  routes[key].forEach(({ from, to, return: isReturn }) => {
    const fromCoord = cityCoords[from];
    const toCoord = cityCoords[to];
    const dist = calculateDistance(fromCoord, toCoord);

    const polyline = L.polyline([fromCoord, toCoord], {
      color: colors[key],
      weight: 3,
      opacity: isReturn ? 0.3 : 0.8
    }).bindPopup(`<b>${capitalize(from)} → ${capitalize(to)}</b><br>Distância: ${dist} km`);

    group.addLayer(polyline);
  });

  routeLayers[key] = group;
}

const legendControl = L.control({ position: 'bottomright' });
legendControl.onAdd = function () {
  const div = L.DomUtil.create('div', 'legend');
  div.innerHTML = '<strong>Mostrar/Ocultar Rotas</strong><br>';
  for (let key in routeLayers) {
    const checkboxId = `route_${key}`;
    div.innerHTML += `<div><label><input type="checkbox" id="${checkboxId}"> <span class="circle-icon" style="background:${colors[key]};"></span>${key.toUpperCase()} (${calculateTotalKm(routes[key])} km)</label></div>`;
  }

  div.innerHTML += '<br><strong>Legenda Círculos</strong><br>';
  div.innerHTML += `<div><span class="circle-icon" style="background:black; opacity:0.8;"></span> Com prémio</div>`;
  div.innerHTML += `<div><span class="circle-icon" style="border:1px solid black; background:transparent;"></span> Sem prémio</div>`;

  return div;
};
legendControl.addTo(map);

function calculateTotalKm(segments) {
  return segments.reduce((sum, { from, to }) => sum + calculateDistance(cityCoords[from], cityCoords[to]), 0);
}

for (let key in routeLayers) {
  document.getElementById(`route_${key}`).addEventListener('change', function (e) {
    if (e.target.checked) {
      routeLayers[key].addTo(map);
    } else {
      map.removeLayer(routeLayers[key]);
    }
  });
}

map.fitBounds(bounds);
</script>
</body>
</html>
